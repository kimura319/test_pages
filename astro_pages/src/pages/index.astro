---
import Layout from '../layouts/Layout.astro';
import TextBox from '../components/textbox.astro';

---

<Layout>
	<div class="demo-container">
		<h2>pagesのデモ</h2>
		
		<TextBox 
			label="お名前" 
			placeholder="山田太郎" 
			type = "text"
			id="name" 
			name="name" 
			required={true}
		/>

		<TextBox 
			label="数値" 
			placeholder="12345" 
			type = "number"
			id="num" 
			name="num" 
			required={true}
		/>

		<div class="button-container">
			<button id="confirmButton" class="confirm-button" disabled>
				決定
			</button>
			<button id="fetch_contents_button" class="fetch-contents-button">
				コンテンツ取得
			</button>
			<button id="binary_download_button" class="binary-download-button" disabled>
				バイナリ取得 
			</button>
		</div>

		<a id="download"></a>ダウンロード

		<div id="resultMessage" class="result-message" style="display: none;">
			<p>こんにちは、<span id="display_name"></span>さん！</p>
			<p>数値は<span id="display_number"></span>です！</p>
		</div>

		<div id="statusMessage" class="status-message" style="display: none;">
			<p id="statusText"></p>
		</div>

		<pre id="fileContent" class="file-content"></pre>

	</div>
</Layout>

<style>
	.demo-container {
		max-width: 600px;
		margin: 150px auto;
		padding: 0 20px;
	}

	.demo-container h2 {
		color: #2A233E;
		font-size: 24px;
		font-weight: bold;
		margin-bottom: 30px;
		text-align: center;
	}

	.button-container {
		display: flex;
		justify-content: center;
		gap: 30px;
		margin-top: 20px;
		margin-bottom: 20px;
	}

	.confirm-button {
		padding: 12px 24px;
		background-color: #FF7E33;
		color: white;
		border: none;
		border-radius: 8px;
		font-size: 16px;
		font-weight: bold;
		cursor: pointer;
		transition: background-color 0.3s ease;
		min-width: 120px;
	}

	.confirm-button:hover:not(:disabled) {
		background-color: #e6691a;
	}

	.confirm-button:disabled {
		background-color: #9ca3af;
		cursor: not-allowed;
	}

	.fetch-contents-button {
		padding: 12px 24px;
		background-color: #FF7E33;
		color: white;
		border: none;
		border-radius: 8px;
		font-size: 16px;
		font-weight: bold;
		cursor: pointer;
		transition: background-color 0.3s ease;
		min-width: 120px;
	}

	.binary-download-button {
		padding: 12px 24px;
		background-color: #8e6eff;
		color: white;
		border: none;
		border-radius: 8px;
		font-size: 16px;
		font-weight: bold;
		cursor: pointer;
		transition: background-color 0.3s ease;
		min-width: 120px;
	}

	.binary-download-button:disabled {
		background-color: #9ca3af;
		cursor: not-allowed;
	}

	.result-message {
		text-align: center;
		padding: 15px;
		background-color: #f0f9ff;
		border: 2px solid #0ea5e9;
		border-radius: 8px;
		margin-top: 20px;
	}

	.result-message p {
		margin: 0;
		color: #0c4a6e;
		font-size: 18px;
		font-weight: bold;
	}

	.result-message span {
		color: #FF7E33;
	}

	.status-message {
		text-align: center;
		padding: 15px;
		border-radius: 8px;
		margin-top: 10px;
	}

	.status-message.success {
		background-color: #f0fdf4;
		border: 2px solid #22c55e;
		color: #15803d;
	}

	.status-message.error {
		background-color: #fef2f2;
		border: 2px solid #ef4444;
		color: #dc2626;
	}

	.status-message.loading {
		background-color: #fefce8;
		border: 2px solid #eab308;
		color: #a16207;
	}

	.status-message p {
		margin: 0;
		font-weight: bold;
	}

</style>

<script>
	import { Octokit } from "@octokit/rest";

	// GitHub Actionsに送信する関数
	async function sendToGitHubActions(username: string, number: string): Promise<void> {
		const owner = 'kimura319';  // GitHubユーザー名
		const repo = 'test_pages';  // リポジトリ名
		
		// デモ用の設定（実際のトークンは入力してください）
		const token = prompt('GitHub Personal Access Tokenを入力してください:');
		
		if (!token) {
			throw new Error('GitHub tokenが設定されていません');
		}

		// Repository Dispatch APIエンドポイント
		const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/cpp.yaml/dispatches`;

		const response = await fetch(url, {
			method: 'POST',
			headers: {
				'Accept': 'application/vnd.github+json',
				'Authorization': `Bearer ${token}`,
				'X-GitHub-Api-Version': '2022-11-28'
			},
			body: JSON.stringify({
				ref: 'main',
				inputs: {
					name: username,
					number: number
				}
			})
		});

		if (!response.ok) {
			// レスポンス詳細も取得
			let errorDetail = '';
			try {
				errorDetail = await response.text();
			} catch {}
			throw new Error(`GitHub API Error: ${response.status} ${response.statusText}\n${errorDetail}`);
		}
	}

	// DOMが読み込まれた後に実行
	document.addEventListener('DOMContentLoaded', function() {
		const nameInput = document.getElementById('name') as HTMLInputElement;
		const numberInput = document.getElementById('num') as HTMLInputElement;
		const confirmButton = document.getElementById('confirmButton') as HTMLButtonElement;
		const fetch_contents_button = document.getElementById('fetch_contents_button') as HTMLButtonElement;
		const binary_download_button = document.getElementById('binary_download_button') as HTMLButtonElement;

		const resultMessage = document.getElementById('resultMessage') as HTMLElement;
		const display_name = document.getElementById('display_name') as HTMLElement;
		const display_number = document.getElementById('display_number') as HTMLElement;
		const statusMessage = document.getElementById('statusMessage') as HTMLElement;
		const statusText = document.getElementById('statusText') as HTMLElement;
		const file_content = document.getElementById('fileContent') as HTMLElement;

		// ダウンロードリンクの設定
		const a = document.getElementById('download') as HTMLAnchorElement;

		if (!nameInput || !confirmButton || !resultMessage || !display_name || !display_number || !statusMessage || !statusText) {
			console.error('Required elements not found');
			return;
		}

		// 入力値の両方がある場合のみボタンを有効化
        function updateButtonState() {
            const name = nameInput.value.trim();
            const num = numberInput.value.trim();
            const enabled = name.length > 0 && num.length > 0;
            confirmButton.disabled = !enabled;
            binary_download_button.disabled = !enabled;
        }

		function display_result_message(name: string, num: string) {
				resultMessage.style.display = 'block';
				resultMessage.className = 'result-message';
				display_name.textContent = name;
				display_number.textContent = num;
        }

		// 名前入力フィールドの変更を監視
		nameInput.addEventListener('input', updateButtonState);
		numberInput.addEventListener('input', updateButtonState);

		// githubのレポジトリからファイルを取得
		fetch_contents_button.addEventListener('click', async function() {
			const owner = 'kimura319';
			const repo = 'test_pages';
			const path = 'src/hello.cpp'; // 取得したいファイルパス
			const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
			
			const response = await fetch(url);
			if (!response.ok) {
				file_content.textContent = '取得失敗: ' + response.statusText;
				return;
			}
			const data = await response.json();
			// base64デコード
			const content = atob(data.content.replace(/\n/g, ''));
			// 正規表現によって、複数の "hello" を 「こんにちわ」に置換
			file_content.textContent = content.replace(/hello/g, 'こんにちは');
		});

		// バイナリ取得ボタンのクリックイベント
		binary_download_button.addEventListener('click', async function() {
			const name = nameInput.value.trim();
			const num = numberInput.value.trim();

			if(name && num) {
				// 入力フィールドをクリア
				nameInput.value = '';
				numberInput.value = '';
				// ボタンを無効化
				updateButtonState();

				// resultMessageの表示
				display_result_message(name, num);
			}

			try {
				const bainary_file = await fetch('/test_pages/firmware.bin'); // 取得したいバイナリファイル名
				const arrayBuffer = await bainary_file.arrayBuffer();

				// arrayBuffer の中身にアクセスするため、Uint8Arrayを使用
				const bytes = new Uint8Array(arrayBuffer);

				// 加工前のバイナリデータを16進数表記に変換（もっと処理を細かく分割したい）
				const original_hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');

				const keyword = "dummy_ssid";
				const keyword_byte = Array.from(keyword).map(b => b.charCodeAt(0));
				
				for (let byte_cnt = 0; byte_cnt < bytes.length - keyword.length ; byte_cnt++) {
					if (keyword_byte.every((char_byte, index) => bytes[byte_cnt + index] === char_byte)) {
						for (let i = 0; i < keyword.length; i++) {
							if (name.length <= i) {
								bytes[byte_cnt + i] = 0; // 名前が短い場合は0で埋める
							}
							bytes[byte_cnt + i] = name.charCodeAt(i);
						}
						break; // 最初の一致のみ処理
					}
				}
				const modified_hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
				
				file_content.textContent = `先頭16バイト\n加工前: ${original_hex}\n加工後: ${modified_hex}`;

				// MIMEタイプを指定し、bytesからBlobを作成
				const blob = new Blob([bytes], { type: 'application/octet-stream' });
				const url = URL.createObjectURL(blob);
				a.href = url;
				a.download = 'modified_hello.exe'; // ダウンロードするファイル名
				a.click(); // 自動的にダウンロードを開始
			} catch (e) {
        	file_content.textContent = 'バイナリ取得失敗: ' + e;
			} 
		});
		
		// 決定ボタンのクリックイベント
		confirmButton.addEventListener('click', async function() {
			const name = nameInput.value.trim();
			const num = numberInput.value.trim();
			if (name && num) {
				// ボタンを無効化
				confirmButton.disabled = true;
				confirmButton.textContent = '送信中...';

				// resultMessageの表示
				display_result_message(name, num);


				// ステータスメッセージを表示
				statusMessage.style.display = 'block';
				statusMessage.className = 'status-message loading';
				statusText.textContent = 'GitHub Actionsに送信しています...';
			}

			try {
				// GitHub Actionsに送信
				await sendToGitHubActions(name, num);    
				statusMessage.className = 'status-message success';
				statusText.textContent = 'GitHub Actionsに正常に送信されました！Actionsタブでワークフローをご確認ください。';

			} catch (error) {
				console.error('送信エラー:', error);
				let errorMessage = '不明なエラーが発生しました';
				if (error instanceof Error) {
					errorMessage = error.message;
				} else if (typeof error === 'string') {
					errorMessage = error;
				}

				statusMessage.className = 'status-message error';
				statusText.textContent = `送信に失敗しました: ${errorMessage}`;
			} finally {
				// 入力フィールドをクリア
				nameInput.value = '';
				numberInput.value = '';
                
				confirmButton.textContent = '決定';
			}
		});

		// Enterキーでも決定できるようにする
		nameInput.addEventListener('keypress', function(event) {
			if (event.key === 'Enter' && !confirmButton.disabled) {
				confirmButton.click();
			}
		});
	});
</script>

